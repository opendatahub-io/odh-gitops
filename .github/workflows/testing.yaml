name: Validate GitOps Manifests

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  tier1-validation:
    name: Tier 1 - Static Validation
    runs-on: ubuntu-latest
    outputs:
      yaml-status: ${{ steps.yaml-check.outcome }}
      kustomize-status: ${{ steps.kustomize-check.outcome }}
      lint-status: ${{ steps.lint-check.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install validation tools
        run: make tools

      - name: Run YAML validation
        id: yaml-check
        continue-on-error: true
        run: |
          make validate-yaml 2>&1 | tee /tmp/yaml-output.txt
          exit ${PIPESTATUS[0]}

      - name: Run Kustomize build validation
        id: kustomize-check
        continue-on-error: true
        run: |
          make validate-kustomize 2>&1 | tee /tmp/kustomize-output.txt
          exit ${PIPESTATUS[0]}

      - name: Run best practices linting
        id: lint-check
        continue-on-error: true
        run: |
          make validate-lint 2>&1 | tee /tmp/lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Generate validation summary
        if: always()
        run: |
          echo "## Tier 1 Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ steps.yaml-check.outcome }}" == "success" && "${{ steps.kustomize-check.outcome }}" == "success" && "${{ steps.lint-check.outcome }}" == "success" ]]; then
            echo "✅ **All static validations passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Some validations failed**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # YAML validation status
          if [[ "${{ steps.yaml-check.outcome }}" == "success" ]]; then
            echo "| YAML Lint | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| YAML Lint | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Kustomize validation status
          if [[ "${{ steps.kustomize-check.outcome }}" == "success" ]]; then
            echo "| Kustomize Build | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Kustomize Build | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Lint validation status
          if [[ "${{ steps.lint-check.outcome }}" == "success" ]]; then
            echo "| Best Practices | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Best Practices | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Show error details for failed checks
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.yaml-check.outcome }}" != "success" || "${{ steps.kustomize-check.outcome }}" != "success" || "${{ steps.lint-check.outcome }}" != "success" ]]; then
            echo "### Error Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [[ "${{ steps.yaml-check.outcome }}" != "success" && -f /tmp/yaml-output.txt ]]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>YAML Lint Errors</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -50 /tmp/yaml-output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "${{ steps.kustomize-check.outcome }}" != "success" && -f /tmp/kustomize-output.txt ]]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>Kustomize Build Errors</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -50 /tmp/kustomize-output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "${{ steps.lint-check.outcome }}" != "success" && -f /tmp/lint-output.txt ]]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>Best Practices Lint Errors</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -50 /tmp/lint-output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Fail if validations failed
        if: steps.yaml-check.outcome != 'success' || steps.kustomize-check.outcome != 'success' || steps.lint-check.outcome != 'success'
        run: |
          echo "One or more Tier 1 validations failed. Check the summary above for details."
          exit 1

  tier2-validation:
    name: Tier 2 - Trigger Konflux Validation
    runs-on: ubuntu-latest
    needs: [tier1-validation]
    if: github.event_name == 'pull_request' && needs.tier1-validation.result == 'success'
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
  
      - name: Trigger Konflux validation
        uses: thollander/actions-comment-pull-request@v3
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          message: '/validate-dependencies'
          comment-tag: konflux-trigger
          mode: recreate
